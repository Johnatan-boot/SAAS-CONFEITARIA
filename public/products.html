<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Produtos - Confeitaria SaaS</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="thema-saas.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    background-color: var(--color-bg, #FFFAFA);
  }

  h1{
    color: var(  --color-text-light, #666);
  }
  h2{
    color: var(  --color-text-light, #666);
  }
  h3{
    color: var(  --color-text-light, #666);
  }

  .btn{
    background-color:var(--color-success, #2ecc71);
    color: #FFFFFF;
  }
  .btn:hover{
    background-color:var(--color-primary, #6F4F37);
    color: #FFFFFF;
  }

    .dashboard-card {
    background: var(  --color-surface, #F5F5DC);
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    transition: transform 0.3s, box-shadow 0.3s;
  }


</style>
</head>
<body class="p-4">

<div class="container">
  <h1 class="mb-4">Produtos</h1>
  <a href="dashboard.html" class="btn btn-secondary mb-3">Voltar ao Dashboard</a>

  <div class="card mb-4 p-3 shadow-sm">
    <h2>Adicionar / Editar Produto</h2>
    <form id="product-form" class="row g-3">
      <input type="hidden" id="product-id">
      <div class="col-md-4">
        <input type="text" class="form-control" name="name" placeholder="Nome" required>
      </div>
      <div class="col-md-4">
        <input type="number" step="0.01" class="form-control" name="price" placeholder="Preço" required>
      </div>
      <div class="col-md-2">
        <input type="number" class="form-control" name="stock" placeholder="Estoque" required>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn w-100">Salvar Produto</button>
      </div>
    </form>
  </div>

  <h2>Lista de Produtos</h2>
  <table class="table table-striped table-hover shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Preço</th>
        <th>Estoque</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="product-list"></tbody>
  </table>

  <h2 class="mt-5">Gráfico de Estoque</h2>
  <canvas id="stock-chart" height="100"></canvas>
</div>

<script>
let chart;

// Carrega produtos e atualiza tabela + gráfico
async function loadProducts() {
  const res = await fetch('/api/products');
  const products = await res.json();

  // Preenche tabela
  const tbody = document.getElementById('product-list');
  tbody.innerHTML = '';
  products.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.id}</td>
      <td>${p.name}</td>
      <td>R$ ${p.price.toFixed(2)}</td>
      <td>${p.stock}</td>
      <td>
        <button class="btn btn btn-sm me-2" onclick="editProduct(${p.id}, '${p.name}', ${p.price}, ${p.stock})">Editar</button>
        <button class="btn btn btn-sm" onclick="deleteProduct(${p.id})">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Atualiza gráfico
  const labels = products.map(p => p.name);
  const data = products.map(p => p.stock);

  if (chart) {
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
  } else {
    const ctx = document.getElementById('stock-chart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Quantidade em Estoque',
          data,
          backgroundColor: '#6F4F37',
          borderColor: '#556B2F',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }
}

function editProduct(id, name, price, stock) {
  document.getElementById('product-id').value = id;
  document.querySelector('input[name="name"]').value = name;
  document.querySelector('input[name="price"]').value = price;
  document.querySelector('input[name="stock"]').value = stock;
}

async function deleteProduct(id) {
  if(!confirm('Deseja realmente excluir este produto?')) return;
  const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
  if (!res.ok) { alert('Erro ao excluir produto'); return; }
  loadProducts();
}

document.getElementById('product-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('product-id').value;
  const name = e.target.name.value;
  const price = parseFloat(e.target.price.value);
  const stock = parseInt(e.target.stock.value);

  let url = '/api/products';
  let method = 'POST';
  if (id) { url += `/${id}`; method = 'PUT'; }

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, price, stock })
  });

  if(!res.ok) { alert('Erro ao salvar produto'); return; }
  e.target.reset();
  document.getElementById('product-id').value = '';
  loadProducts();
});

loadProducts();
</script>

</body>
</html>
