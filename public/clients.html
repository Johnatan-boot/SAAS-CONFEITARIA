<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Clientes - Confeitaria SaaS</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="thema-saas.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>

  body {
    background-color: var(--color-bg, #FFFAFA);
  }

  h1{
    color: var(  --color-text-light, #666);
  }
  h2{
    color: var(  --color-text-light, #666);
  }
  h3{
    color: var(  --color-text-light, #666);
  }

  .btn{
    background-color:var(--color-success, #2ecc71);
    color: #FFFFFF;
  }
  .btn:hover{
    background-color:var(--color-primary, #6F4F37);
    color: #FFFFFF;
  }

    .dashboard-card {
    background: var(  --color-surface, #F5F5DC);
    border-radius: 0.75rem;
    padding: 1.5rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    transition: transform 0.3s, box-shadow 0.3s;
  }
#feedback-list {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
  list-style: none;
  padding: 0;
  margin-top: 1rem;
}

#feedback-list li {
  display: flex;
  align-items: flex-start;
  background-color: #f8f9fa;
  padding: 1rem;
  border-radius: 0.5rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  max-width: 450px;
  width: 100%;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

#feedback-list li:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
}

#feedback-list li img {
  width: 70px;
  height: 70px;
  object-fit: cover;
  border-radius: 50%;
  margin-right: 1rem;
}

.feedback-content {
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.feedback-text {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.95rem;
  word-break: break-word;
}

@media (max-width: 768px) {
  #feedback-list li {
    max-width: 350px;
  }
  #feedback-list li img {
    width: 60px;
    height: 60px;
  }
}

@media (max-width: 480px) {
  #feedback-list li {
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  #feedback-list li img {
    margin-bottom: 0.5rem;
    margin-right: 0;
  }
  .feedback-text {
    justify-content: center;
  }
}
</style>


</head>
<body class="p-4">

<div class="container">
  <h1 class="mb-4">Clientes</h1>
  <a href="dashboard.html" class="btn btn mb-3">Voltar ao Dashboard</a>

  <!-- Formulário de Adição / Edição -->
  <div class="card mb-4 p-3 shadow-sm">
    <h2>Adicionar / Editar Cliente</h2>
    <form id="client-form" class="row g-3">
      <input type="hidden" name="id" id="client-id">
      <div class="col-md-4">
        <input type="text" class="form-control" name="name" placeholder="Nome" required>
      </div>
      <div class="col-md-4">
        <input type="email" class="form-control" name="email" placeholder="Email" required>
      </div>
      <div class="col-md-4">
        <select name="status" class="form-select" required>
          <option value="Satisfeito">Satisfeito</option>
          <option value="Insatisfeito">Insatisfeito</option>
          <option value="A melhorar">A melhorar</option>
        </select>
      </div>
      <div class="col-12">
        <button type="submit" class="btn btn w-100">Salvar</button>
      </div>
    </form>
  </div>

  <!-- Lista de Clientes -->
  <h2>Lista de Clientes</h2>
  <table class="table table-striped table-hover shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Nome</th>
        <th>Email</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="client-list"></tbody>
  </table>

  <!-- Gráfico de Satisfação -->
  <div class="card p-3 shadow-sm mt-4">
    <h2>Gráfico de Satisfação</h2>
    <div class="chart-container">
      <canvas id="clientsChart"></canvas>
    </div>
  </div>
</div>

<h3 class="text-center">Feedbacks</h3>
<ul id="feedback-list"></ul>

<script>
let clientsChart;

// Inicialização da página
async function initPage() {
  await loadClients();
  await loadFeedbacks();
}

// Função para carregar clientes
async function loadClients() {
  const res = await fetch('/api/clients');
  if (!res.ok) {
    alert('Você precisa estar logado para ver os clientes');
    return;
  }
  const clients = await res.json();

  // Atualiza tabela
  const tbody = document.getElementById('client-list');
  tbody.innerHTML = '';
  clients.forEach(c => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c.id}</td>
      <td>${c.name}</td>
      <td>${c.email}</td>
      <td>${c.status}</td>
      <td>
        <button class="btn btn btn-sm me-2" onclick="giveFeedback(${c.id}, '${c.name}')">Dar Feedback</button>
        <button class="btn btn btn-sm me-2" onclick="editClient(${c.id}, '${c.name}', '${c.email}', '${c.status}')">Editar</button>
        <button class="btn btn btn-sm" onclick="deleteClient(${c.id})">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Atualiza gráfico
  updateChart(clients);
}





document.getElementById('client-form').addEventListener('submit', async function(e) {
  e.preventDefault(); // evita o reload da página

  const id = document.getElementById('client-id').value;
  const name = this.name.value;
  const email = this.email.value;
  const status = this.status.value;

  let url = '/api/clients';
  let method = 'POST';

  if (id) { // se existe ID, é edição
    url += `/${id}`;
    method = 'PUT';
  }

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, status })
  });

  if (!res.ok) {
    const err = await res.json();
    alert('Erro: ' + err.error);
  } else {
    alert('Cliente salvo com sucesso!');
    this.reset(); // limpa formulário
    document.getElementById('client-id').value = '';
    loadClients(); // recarrega tabela
  }
});


// Função para enviar feedback
async function sendFeedback(client_id, rating, comment, fileInputId) {
  const inputFile = document.getElementById(fileInputId);
  let file = null;
  if (inputFile && inputFile.files.length > 0) {
    file = inputFile.files[0];
  }

  const formData = new FormData();
  formData.append("client_id", client_id);
  formData.append("rating", rating);
  formData.append("comment", comment);
  if (file) formData.append("photo", file);

  const res = await fetch("/api/feedbacks", { method: "POST", body: formData });
  if (!res.ok) {
    const err = await res.json();
    alert("Erro ao registrar feedback: " + err.error);
  } else {
    alert("Feedback registrado com sucesso!");
    loadFeedbacks(); // recarrega a lista
  }
}

// Corrigir a exibição das fotos nos feedbacks
async function loadFeedbacks() {
  const res = await fetch("/api/feedbacks");
  if (!res.ok) return;
  const feedbacks = await res.json();

  const feedbackList = document.getElementById("feedback-list");
  feedbackList.innerHTML = '';

  feedbacks.forEach(f => {
    const li = document.createElement('li');

    // Coluna 1: imagem
   if (f.photo) {
  const img = document.createElement('img');

  // Caso seja base64 já vem pronto
  if (f.photo.startsWith("data:image")) {
    img.src = f.photo;
  } else {
    // Caso seja apenas o nome/URL vindo do backend
    img.src = `/uploads/${f.photo}`;
  }

  li.appendChild(img);
} else {
  // Avatar padrão se não tiver imagem
  const img = document.createElement('img');
  img.src = "https://via.placeholder.com/70x70.png?text=User";
  li.appendChild(img);
}


    // Coluna 2: estrela + texto
    const contentDiv = document.createElement('div');
    contentDiv.classList.add('feedback-content');

    const textDiv = document.createElement('div');
    textDiv.classList.add('feedback-text');
    textDiv.innerHTML = `<strong>${f.client_name}</strong>: ⭐ ${f.rating} - ${f.comment || ''}`;

    contentDiv.appendChild(textDiv);
    li.appendChild(contentDiv);

    feedbackList.appendChild(li);
  });
}


// Função para redirecionar ao feedback
function giveFeedback(id, name) {
  localStorage.setItem('feedbackClientId', id);
  localStorage.setItem('feedbackClientName', name);
  window.location.href = 'feedbacks.html';
}




// Função Editar
function editClient(id, name, email, status) {
  document.getElementById('client-id').value = id;
  document.querySelector('input[name="name"]').value = name;
  document.querySelector('input[name="email"]').value = email;
  document.querySelector('select[name="status"]').value = status;
}

// Função Excluir
async function deleteClient(id) {
  if (!confirm('Deseja realmente excluir este cliente?')) return;
  const res = await fetch(`/api/clients/${id}`, { method: 'DELETE' });
  if (!res.ok) {
    alert('Erro ao excluir cliente');
    return;
  }
  loadClients();
}

// Função para atualizar gráfico Chart.js
function updateChart(clients) {
  const statusCounts = { 'Satisfeito': 0, 'Insatisfeito': 0, 'A melhorar': 0 };
  clients.forEach(c => { statusCounts[c.status] = (statusCounts[c.status] || 0) + 1; });

  const data = {
    labels: Object.keys(statusCounts),
    datasets: [{
      label: 'Clientes',
      data: Object.values(statusCounts),
      backgroundColor: ['#556B2F', '#e74c3c', '#6F4F37']
    }]
  };

  const ctx = document.getElementById('clientsChart').getContext('2d');

  if (clientsChart) {
    clientsChart.data = data;
    clientsChart.update();
  } else {
    clientsChart = new Chart(ctx, {
      type: 'pie',
      data: data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }
}

// Inicializa a página
initPage();
</script>

</body>
</html>
